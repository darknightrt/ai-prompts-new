# Cloudflare D1 æ•°æ®åº“éƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®æ”¯æŒä¸¤ç§å­˜å‚¨æ–¹å¼ï¼š
- **localStorage** (é»˜è®¤) - æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ï¼Œé€‚åˆå•ç”¨æˆ·/å¼€å‘ç¯å¢ƒ
- **D1** - Cloudflare D1 æ•°æ®åº“ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒï¼Œæ”¯æŒæ•°æ®æŒä¹…åŒ–å’Œå¤šç«¯åŒæ­¥

## ğŸ—ï¸ æ¶æ„è¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯ (Next.js)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ PromptContextâ”‚    â”‚   API Routes â”‚    â”‚  Components â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                  â”‚                                â”‚
â”‚         â–¼                  â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚           Storage Layer (db.ts)          â”‚               â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚               â”‚
â”‚  â”‚  â”‚localStorageâ”‚    â”‚   D1Storage    â”‚   â”‚               â”‚
â”‚  â”‚  â”‚   (é»˜è®¤)   â”‚    â”‚  (Cloudflare)  â”‚   â”‚               â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Cloudflare D1  â”‚
                    â”‚   (SQLite)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ Cloudflare D1 éƒ¨ç½²æ­¥éª¤

### 1. åˆ›å»º D1 æ•°æ®åº“

1. ç™»å½• [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. è¿›å…¥ **å­˜å‚¨å’Œæ•°æ®åº“** â†’ **D1 SQL æ•°æ®åº“**
3. ç‚¹å‡» **åˆ›å»ºæ•°æ®åº“**
4. è¾“å…¥æ•°æ®åº“åç§°ï¼Œä¾‹å¦‚ï¼š`ai-prompts-db`
5. é€‰æ‹©åŒºåŸŸï¼Œç‚¹å‡»åˆ›å»º

### 2. åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„

1. è¿›å…¥åˆ›å»ºçš„ D1 æ•°æ®åº“
2. ç‚¹å‡» **æ§åˆ¶å°** æˆ– **Explore Data**
3. å°† `d1-init.sql` æ–‡ä»¶å†…å®¹ç²˜è´´åˆ°æŸ¥è¯¢çª—å£
4. ç‚¹å‡» **æ‰§è¡Œ** è¿è¡Œæ‰€æœ‰ SQL è¯­å¥

```sql
-- æ ¸å¿ƒè¡¨ç»“æ„
- users (ç”¨æˆ·è¡¨)
- prompts (æç¤ºè¯è¡¨)
- favorites (æ”¶è—è¡¨)
- usage_records (ä½¿ç”¨è®°å½•è¡¨)
```

### 3. åˆ›å»º Cloudflare Pages é¡¹ç›®

1. è¿›å…¥ **Workers å’Œ Pages**
2. ç‚¹å‡» **åˆ›å»ºåº”ç”¨ç¨‹åº** â†’ **Pages**
3. è¿æ¥ Git ä»“åº“æˆ–ç›´æ¥ä¸Šä¼ 
4. é…ç½®æ„å»ºè®¾ç½®ï¼š
   - **æ¡†æ¶é¢„è®¾**: Next.js
   - **æ„å»ºå‘½ä»¤**: `npm run pages:build`
   - **æ„å»ºè¾“å‡ºç›®å½•**: `.vercel/output/static`

### 4. ç»‘å®š D1 æ•°æ®åº“

1. è¿›å…¥ Pages é¡¹ç›®è®¾ç½®
2. ç‚¹å‡» **è®¾ç½®** â†’ **ç»‘å®š**
3. æ·»åŠ  **D1 æ•°æ®åº“** ç»‘å®š
4. **å˜é‡åç§°**: `DB` (å¿…é¡»å¤§å†™)
5. **D1 æ•°æ®åº“**: é€‰æ‹©æ­¥éª¤ 1 åˆ›å»ºçš„æ•°æ®åº“

### 5. é…ç½®ç¯å¢ƒå˜é‡

åœ¨ Pages é¡¹ç›®è®¾ç½®ä¸­æ·»åŠ ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

| å˜é‡å | å€¼ | è¯´æ˜ |
|--------|-----|------|
| `NEXT_PUBLIC_STORAGE_TYPE` | `d1` | å¯ç”¨ D1 å­˜å‚¨æ¨¡å¼ |
| `NODE_VERSION` | `18` | Node.js ç‰ˆæœ¬ |

### 6. éƒ¨ç½²

ä¿å­˜é…ç½®åè§¦å‘é‡æ–°éƒ¨ç½²ï¼Œæˆ–æ‰‹åŠ¨ç‚¹å‡» **é‡æ–°éƒ¨ç½²**ã€‚

## ğŸ“ é¡¹ç›®æ–‡ä»¶ç»“æ„

```
ai-prompts-mini/
â”œâ”€â”€ d1-init.sql                    # D1 æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ storage.types.ts       # å­˜å‚¨ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ d1.storage.ts          # D1 å­˜å‚¨å®ç°
â”‚   â”‚   â”œâ”€â”€ db.ts                  # å­˜å‚¨å±‚æŠ½è±¡
â”‚   â”‚   â””â”€â”€ types.tsx              # æ•°æ®ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ context/
â”‚   â”‚   â””â”€â”€ PromptContext.tsx      # æç¤ºè¯ä¸Šä¸‹æ–‡ (æ”¯æŒå¤šå­˜å‚¨)
â”‚   â””â”€â”€ app/
â”‚       â””â”€â”€ api/
â”‚           â””â”€â”€ prompts/           # API è·¯ç”±
â”‚               â”œâ”€â”€ route.ts       # GET/POST æç¤ºè¯
â”‚               â”œâ”€â”€ [id]/route.ts  # GET/PUT/DELETE å•ä¸ª
â”‚               â””â”€â”€ batch/route.ts # æ‰¹é‡æ“ä½œ
â”œâ”€â”€ package.json                   # é¡¹ç›®ä¾èµ–
â””â”€â”€ D1_DEPLOY_GUIDE.md            # æœ¬æ–‡æ¡£
```

## ğŸ”§ æœ¬åœ°å¼€å‘

### é»˜è®¤æ¨¡å¼ (localStorage)

```bash
# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev
```

é»˜è®¤ä½¿ç”¨ localStorageï¼Œæ— éœ€é…ç½®æ•°æ®åº“ã€‚

### D1 æ¨¡å¼ (éœ€è¦ Wrangler)

```bash
# å®‰è£… Wrangler CLI
npm install -g wrangler

# ç™»å½• Cloudflare
wrangler login

# åˆ›å»ºæœ¬åœ° D1 æ•°æ®åº“
wrangler d1 create ai-prompts-db --local

# åˆå§‹åŒ–è¡¨ç»“æ„
wrangler d1 execute ai-prompts-db --local --file=d1-init.sql

# ä½¿ç”¨ Wrangler Pages å¼€å‘
npm run pages:dev
```

## ğŸ“Š å­˜å‚¨æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | localStorage | D1 |
|------|-------------|-----|
| æ•°æ®æŒä¹…åŒ– | âŒ æµè§ˆå™¨æ¸…é™¤åä¸¢å¤± | âœ… æ°¸ä¹…å­˜å‚¨ |
| å¤šç«¯åŒæ­¥ | âŒ ä»…å½“å‰æµè§ˆå™¨ | âœ… æ‰€æœ‰è®¾å¤‡ |
| æœåŠ¡å™¨è¦æ±‚ | æ—  | Cloudflare Pages |
| é€‚ç”¨åœºæ™¯ | å¼€å‘/æ¼”ç¤º | ç”Ÿäº§ç¯å¢ƒ |
| æŸ¥è¯¢èƒ½åŠ› | å¼± | å¼º (SQL) |

## ğŸ” å®‰å…¨å»ºè®®

1. **ä¿®æ”¹é»˜è®¤å¯†ç **: éƒ¨ç½²åç«‹å³ä¿®æ”¹ `d1-init.sql` ä¸­çš„é»˜è®¤ç®¡ç†å‘˜å¯†ç 
2. **ä½¿ç”¨ç¯å¢ƒå˜é‡**: æ•æ„Ÿä¿¡æ¯é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®
3. **å¯ç”¨ HTTPS**: Cloudflare é»˜è®¤æä¾› HTTPS
4. **å®šæœŸå¤‡ä»½**: åœ¨ D1 æ§åˆ¶å°å®šæœŸå¯¼å‡ºæ•°æ®

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**1. "D1 database is only available in Cloudflare Pages environment"**
- åŸå› : åœ¨é Cloudflare ç¯å¢ƒè®¿é—® D1
- è§£å†³: ç¡®ä¿éƒ¨ç½²åˆ° Cloudflare Pagesï¼Œæˆ–æœ¬åœ°ä½¿ç”¨ localStorage æ¨¡å¼

**2. API è¿”å› 400 é”™è¯¯**
- åŸå› : `NEXT_PUBLIC_STORAGE_TYPE` æœªè®¾ç½®ä¸º `d1`
- è§£å†³: æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®

**3. æ•°æ®åº“è¡¨ä¸å­˜åœ¨**
- åŸå› : æœªæ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
- è§£å†³: åœ¨ D1 æ§åˆ¶å°æ‰§è¡Œ `d1-init.sql`

**4. ç»‘å®šæ— æ•ˆ**
- åŸå› : å˜é‡åç§°ä¸æ˜¯ `DB`
- è§£å†³: ç¡®ä¿ç»‘å®šå˜é‡åä¸ºå¤§å†™ `DB`

## ğŸ“ API æ–‡æ¡£

### GET /api/prompts
è·å–æ‰€æœ‰æç¤ºè¯

**å“åº”:**
```json
{
  "prompts": [...],
  "success": true
}
```

### POST /api/prompts
åˆ›å»ºæ–°æç¤ºè¯

**è¯·æ±‚ä½“:**
```json
{
  "title": "æ ‡é¢˜",
  "prompt": "æç¤ºè¯å†…å®¹",
  "category": "code",
  "type": "icon"
}
```

### PUT /api/prompts/[id]
æ›´æ–°æç¤ºè¯

### DELETE /api/prompts/[id]
åˆ é™¤æç¤ºè¯

### POST /api/prompts/batch
æ‰¹é‡å¯¼å…¥

### DELETE /api/prompts/batch
æ‰¹é‡åˆ é™¤

## ğŸ¯ æœ€ä½³å®è·µ

1. **å¼€å‘é˜¶æ®µ**: ä½¿ç”¨ localStorage æ¨¡å¼å¿«é€Ÿè¿­ä»£
2. **æµ‹è¯•é˜¶æ®µ**: ä½¿ç”¨ Wrangler æœ¬åœ° D1 æµ‹è¯•
3. **ç”Ÿäº§éƒ¨ç½²**: ä½¿ç”¨ Cloudflare Pages + D1

## ğŸ“š å‚è€ƒèµ„æº

- [Cloudflare D1 æ–‡æ¡£](https://developers.cloudflare.com/d1/)
- [Cloudflare Pages æ–‡æ¡£](https://developers.cloudflare.com/pages/)
- [Next.js on Cloudflare Pages](https://developers.cloudflare.com/pages/framework-guides/nextjs/)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2024-12-01
